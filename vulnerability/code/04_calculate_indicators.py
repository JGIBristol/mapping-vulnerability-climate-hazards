import pandas as pd

import config


if __name__ == '__main__':
    config.indicators_data_dir.mkdir(parents=True, exist_ok=True)

    lsoa_data = pd.read_csv(config.combined_data_dir / 'lsoa_data.csv')
    msoa_data = pd.read_csv(config.combined_data_dir / 'msoa_data.csv')
    lsoa_2011_data = pd.read_csv(config.combined_data_dir / 'lsoa_2011_data.csv')
    
    lsoa_indicators = lsoa_data[['geography code', 'geography']].set_axis(['lsoa21cd', 'lsoa21nm'], axis=1).copy()
    msoa_indicators = msoa_data[['geography code', 'geography']].set_axis(['msoa21cd', 'msoa21nm'], axis=1).copy()
    lsoa_2011_indicators = lsoa_2011_data[['LSOA code (2011)', 'LSOA name (2011)']].set_axis(['lsoa11cd', 'lsoa11nm'], axis=1).copy()

    for data_source in config.data_sources:
        if 'indicators' in data_source:
            if data_source['type'] == 'census_lsoa_metric':
                for indicator, formula in data_source['indicators'].items():
                    lsoa_indicators[indicator] = lsoa_data.eval(formula)
            elif data_source['type'] == 'census_msoa_metric':
                for indicator, formula in data_source['indicators'].items():
                    msoa_indicators[indicator] = msoa_data.eval(formula)
            elif data_source['type'] == 'imd_lsoa_2011_metric':
                for indicator, formula in data_source['indicators'].items():
                    lsoa_2011_indicators[indicator] = lsoa_2011_data.eval(formula)

    lsoa_indicators.to_csv(config.indicators_data_dir / 'lsoa_indicators.csv', index=False)
    msoa_indicators.to_csv(config.indicators_data_dir / 'msoa_indicators.csv', index=False)
    lsoa_2011_indicators.to_csv(config.indicators_data_dir / 'lsoa_2011_indicators.csv', index=False)
